

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Colocating Sentinel-3 OLCI and Sentinal-2 Optical Data &#8212; GEOL0069 Guide Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Chapter1:Data_Colocating_S2_S3';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Unsupervised Learning" href="Chapter1%3AUnsupervised_Learning_Methods.html" />
    <link rel="prev" title="Roll-out on a Full Image" href="Chapter%201%3Arollout.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to GEOL0069 AI for Earth Observation
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 1</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3APreparation.html">Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3AIRIS.html">Introduction to Intelligently Reinforced Image Segmentation (IRIS)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 2</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3AML.html">Introduction to AI/Machine Learning</a></li>

<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3ASea-ice_and_Lead_Classification.html">Sea-ice and Lead Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3AAI_Algorithms.html">AI/Machine Learning Implementation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 3</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3AFetching_Data.html">Data Fetching</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter%201%3Arollout.html">Roll-out on a Full Image</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 4</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Colocating Sentinel-3 OLCI and Sentinal-2 Optical Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter1%3AUnsupervised_Learning_Methods.html">Unsupervised Learning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Week 5</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Chapter1%3ARegression.html">Regression Techniques for Predictive Analysis</a></li>

<li class="toctree-l1"><a class="reference internal" href="Chapter1%3AAligning_Images.html">Aligning Sentinel-2 and Sentinel-3 OLCI Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="References1.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Chapter1:Data_Colocating_S2_S3.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Colocating Sentinel-3 OLCI and Sentinal-2 Optical Data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-0-read-in-functions-needed">Step 0: Read in Functions Needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-get-the-pairs-of-colocated-s2-s3">Step 1: Get the Pairs of Colocated S2/S3</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proceeding-with-sentinel-3-olci-download">Proceeding with Sentinel-3 OLCI Download</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-colocated-altimetry-data-of-sentinel-3-olci">Downloading Colocated Altimetry Data of Sentinel-3 OLCI</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="colocating-sentinel-3-olci-and-sentinal-2-optical-data">
<h1>Colocating Sentinel-3 OLCI and Sentinal-2 Optical Data<a class="headerlink" href="#colocating-sentinel-3-olci-and-sentinal-2-optical-data" title="Permalink to this heading">#</a></h1>
<p>In this section, we embark on a detailed exploration of colocating Sentinel-3 OLCI (Ocean and Land Colour Instrument) data with Sentinel-2 optical data. Colocation of data from these two satellite missions enables a powerful synergy, harnessing the high spatial resolution of Sentinel-2 and the comprehensive coverage and colocated altimeter data from Sentinel-3. This fusion of datasets provides a richer, more detailed perspective of Earth’s surface.</p>
<p>In the following sections, we will guide you through the necessary steps to efficiently identify and align these datasets.</p>
<p>Week 4 materials are available <a class="reference external" href="https://drive.google.com/drive/folders/1gNQ-DHs2kTprvKRXuKwbW_7yMsmD7-Hp?usp=sharing">here</a>.</p>
<section id="step-0-read-in-functions-needed">
<h2>Step 0: Read in Functions Needed<a class="headerlink" href="#step-0-read-in-functions-needed" title="Permalink to this heading">#</a></h2>
<p>To streamline our data fetching and processing, we’ll first load the essential functions. These functions are designed to handle various tasks such as data retrieval, format conversion, and preliminary data processing. Ensure that you’ve imported all the required functions before proceeding to the next steps of the workflow. All functions have docstrings so please read them to get some ideas of what they do.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ee</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">get_matched_S2_image_ids</span><span class="p">(</span><span class="n">s3_image</span><span class="p">,</span><span class="n">boundary_geometry</span><span class="p">):</span>
        <span class="n">s3_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">s3_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system:time_start&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        
        <span class="c1"># Define a time window for S2 search (±3 hours from S3 image time)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">s3_time</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">s3_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Query for S2 images within the time window and spatial extent of S3</span>
        <span class="n">S2_collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s1">&#39;COPERNICUS/S2&#39;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">boundary_geometry</span><span class="p">)</span>

        <span class="c1"># Return the list of S2 image IDs</span>
        <span class="k">return</span> <span class="n">S2_collection</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;system:index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">find_matched_satellite_images</span><span class="p">(</span><span class="n">S3_date_range</span><span class="p">,</span> <span class="n">S3_spatial_extent</span><span class="p">,</span> <span class="n">boundary_geometry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to find matched Sentinel-2 image IDs for each Sentinel-3 image in the given date range and spatial extent.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define variables for Sentinel-3 query</span>
    <span class="n">S3_product</span> <span class="o">=</span> <span class="s1">&#39;COPERNICUS/S3/OLCI&#39;</span>

    <span class="c1"># Query for Sentinel-3 data</span>
    <span class="n">S3_collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">S3_product</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">S3_date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">S3_date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">boundary_geometry</span><span class="p">)</span>

    <span class="c1"># Convert S3_collection to a list of image IDs</span>
    <span class="n">S3_image_ids</span> <span class="o">=</span> <span class="n">S3_collection</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;system:index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="c1"># List to store matched pairs</span>
    <span class="n">matched_pairs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop through each S3 image ID and find matching S2 images</span>
    <span class="k">for</span> <span class="n">s3_image_id</span> <span class="ow">in</span> <span class="n">S3_image_ids</span><span class="p">:</span>
        <span class="n">s3_image</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">S3_collection</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s1">&#39;system:index&#39;</span><span class="p">,</span> <span class="n">s3_image_id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
        <span class="n">matched_S2_image_ids</span> <span class="o">=</span> <span class="n">get_matched_S2_image_ids</span><span class="p">(</span><span class="n">s3_image</span><span class="p">,</span><span class="n">boundary_geometry</span><span class="p">)</span>

        <span class="c1"># Record each pair of matched S3 and S2 images</span>
        <span class="k">for</span> <span class="n">s2_image_id</span> <span class="ow">in</span> <span class="n">matched_S2_image_ids</span><span class="p">:</span>
            <span class="n">matched_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s3_image_id</span><span class="p">,</span> <span class="n">s2_image_id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">matched_pairs</span>

<span class="k">def</span> <span class="nf">parse_gee_filename</span><span class="p">(</span><span class="n">gee_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the Google Earth Engine filename to extract satellite name, sensing date, and start time.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    gee_filename (str): Filename obtained from Google Earth Engine.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple: Contains satellite name, sensing date, and start time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">gee_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">sensing_date</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tile_number</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sensing_date</span><span class="p">,</span> <span class="n">tile_number</span>

<span class="k">def</span> <span class="nf">parse_gee_filename_s3</span><span class="p">(</span><span class="n">gee_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the Google Earth Engine filename to extract satellite name, sensing date, and start time.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    gee_filename (str): Filename obtained from Google Earth Engine.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple: Contains satellite name, sensing date, and start time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">gee_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">satellite</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_OL_1_EFR&#39;</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Extract date from the start_datetime (assuming the format is like &#39;20180601T014926&#39;)</span>
    <span class="n">sensing_date</span> <span class="o">=</span> <span class="n">start_datetime</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>  
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">start_datetime</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>   

    <span class="k">return</span> <span class="n">satellite</span><span class="p">,</span> <span class="n">sensing_date</span><span class="p">,</span> <span class="n">start_time</span>

<span class="c1"># Function to get an access token</span>
<span class="k">def</span> <span class="nf">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves access token from Copernicus Dataspace using the provided credentials.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    username (str): Username for Copernicus Dataspace.</span>
<span class="sd">    password (str): Password for Copernicus Dataspace.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: Access token for authenticated sessions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cdse-public&#39;</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>


<span class="c1"># Function to query Sentinel-2 data from Copernicus Data Space</span>
<span class="k">def</span> <span class="nf">query_sentinel2_data</span><span class="p">(</span><span class="n">sensing_start_date</span><span class="p">,</span> <span class="n">tile_number</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries the Sentinel-2 data from the Copernicus Data Space based on sensing start date, tile number, and access token.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    sensing_start_date (str): The start date and time for the data sensing in the format &#39;YYYYMMDDTHHMMSS&#39;.</span>
<span class="sd">    tile_number (str): The specific tile number of the Sentinel-2 data to be queried.</span>
<span class="sd">    token (str): The access token for authenticating requests to the Copernicus Data Space.</span>

<span class="sd">    Returns:</span>
<span class="sd">    DataFrame: A DataFrame containing the query results with details about the Sentinel-2 data.</span>
<span class="sd">    </span>
<span class="sd">    The function constructs a query URL with specified parameters, sends a request to the Copernicus Data Space,</span>
<span class="sd">    and returns the results as a DataFrame. It filters the data based on the tile number and the content start date</span>
<span class="sd">    within a certain time window.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert sensing_start_date to datetime object and format it for the query</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">sensing_start_date</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Adjust the time window as necessary</span>
    <span class="n">start_time_str</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
    <span class="n">end_time_str</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="c1"># Construct the request URL with the contains function for tile number</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://catalogue.dataspace.copernicus.eu/odata/v1/Products?$filter=contains(Name,&#39;</span><span class="si">{</span><span class="n">tile_number</span><span class="si">}</span><span class="s2">&#39;) and Collection/Name eq &#39;SENTINEL-2&#39; and ContentDate/Start gt </span><span class="si">{</span><span class="n">start_time_str</span><span class="si">}</span><span class="s2"> and ContentDate/Start lt </span><span class="si">{</span><span class="n">end_time_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

    <span class="c1"># Make the API request</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">extract_correct_product_name</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">tile_number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the correct product name and ID from a dataframe based on a specific start time and tile number.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    df (DataFrame): The dataframe containing product information.</span>
<span class="sd">    start_time (str): The start time used to filter the products.</span>
<span class="sd">    tile_number (str): The tile number used to filter the products.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple: A tuple containing the first matching product name and ID, or (None, None) if no match is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Adjusted regex pattern to match the filename format</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;MSIL1C.*</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s1">.*_</span><span class="si">{</span><span class="n">tile_number</span><span class="si">}</span><span class="s1">_&#39;</span>
    <span class="n">filtered_products</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    
    
    <span class="c1"># Return the first matching product name, or None if not found</span>
    <span class="k">return</span> <span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_products</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_products</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">process_image_pair</span><span class="p">(</span><span class="n">s2_ee_image_id</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a pair of Sentinel-2 images by querying the Copernicus Data Space to find the corresponding product name and ID.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    s2_ee_image_id (str): The Sentinel-2 Earth Engine image ID.</span>
<span class="sd">    token (str): The access token for authenticating requests to the Copernicus Data Space.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple: A tuple containing the product name and ID for the corresponding Sentinel-2 image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sensing_start_date</span> <span class="o">=</span> <span class="n">s2_ee_image_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tile_number</span> <span class="o">=</span> <span class="n">s2_ee_image_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Query the Copernicus Data Space</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">query_sentinel2_data</span><span class="p">(</span><span class="n">sensing_start_date</span><span class="p">,</span> <span class="n">tile_number</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>

    <span class="c1"># Extract the correct MSIL1C product name</span>
    <span class="k">return</span> <span class="n">extract_correct_product_name</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sensing_start_date</span><span class="p">,</span> <span class="n">tile_number</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">download_single_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="s2">&quot;downloaded_products&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a single product from the Copernicus Data Space.</span>

<span class="sd">    :param product_id: The unique identifier for the product.</span>
<span class="sd">    :param file_name: The name of the file to be downloaded.</span>
<span class="sd">    :param access_token: The access token for authorization.</span>
<span class="sd">    :param download_dir: The directory where the product will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure the download directory exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Construct the download URL</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://zipper.dataspace.copernicus.eu/odata/v1/Products(</span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">)/$value&quot;</span>

    <span class="c1"># Set up the session and headers</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Perform the request</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Check if the request was successful</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="c1"># Define the path for the output file</span>
        <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.zip&quot;</span><span class="p">)</span>

        <span class="c1"># Stream the content to a file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">output_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download product </span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2">. Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">query_sentinel3_olci_data</span><span class="p">(</span><span class="n">satellite</span><span class="p">,</span> <span class="n">sensing_date</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries Sentinel-3 OLCI data from Copernicus Data Space based on satellite name, sensing date, and start time.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    satellite (str): Name of the satellite.</span>
<span class="sd">    sensing_date (str): Date of the data sensing.</span>
<span class="sd">    start_time (str): Start time of the data sensing.</span>
<span class="sd">    token (str): Access token for authentication.</span>

<span class="sd">    Returns:</span>
<span class="sd">    DataFrame: A DataFrame containing the query results with details about the Sentinel-3 OLCI data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert sensing_date to datetime object and format it for the query</span>
    <span class="n">sensing_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sensing_date</span><span class="si">}</span><span class="s1">T</span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">sensing_datetime</span> <span class="o">=</span> <span class="n">sensing_datetime</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Construct the request URL using the filter structure provided</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;https://catalogue.dataspace.copernicus.eu/odata/v1/Products?&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;$filter=contains(Name,&#39;</span><span class="si">{</span><span class="n">satellite</span><span class="si">}</span><span class="s2">&#39;) and &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ContentDate/Start ge </span><span class="si">{</span><span class="n">sensing_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.000Z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> and &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;ContentDate/Start le </span><span class="si">{</span><span class="p">(</span><span class="n">sensing_datetime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.000Z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;$orderby=ContentDate/Start&amp;$top=1000&quot;</span>
    <span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

    <span class="c1"># Print the URL for debugging</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Make the API request</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="c1"># Check if the request was successful</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="c1"># Print error details and return an empty DataFrame if the request failed</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Unable to fetch data. Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">. Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="c1"># Convert the JSON response to a DataFrame</span>
    <span class="n">search_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    
    <span class="c1"># Convert the &#39;ContentDate/Start&#39; to datetime objects and sort the results</span>
    <span class="n">search_results_df</span><span class="p">[</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">search_results_df</span><span class="p">[</span><span class="s1">&#39;ContentDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]))</span>
    <span class="n">search_results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">search_results_df</span>



<span class="k">def</span> <span class="nf">fetch_S3_images_by_area_and_date</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="n">spatial_extent</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches Sentinel-3 OLCI images based on a specified date range and area of interest.</span>
<span class="sd">    </span>
<span class="sd">    :param date_range: List containing the start and end dates (e.g., [&#39;2018-06-01&#39;, &#39;2018-06-02&#39;])</span>
<span class="sd">    :param spatial_extent: List containing the spatial extent [min_lon, min_lat, max_lon, max_lat]</span>
<span class="sd">    :param area_of_interest: ee.Geometry object defining the specific area for which to fetch images</span>
<span class="sd">    </span>
<span class="sd">    :return: List of dictionaries, each containing details about a fetched image, including its ID, date, and download URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize the Earth Engine module</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>

    <span class="c1"># Define variables for Sentinel-3 OLCI query</span>
    <span class="n">S3_product</span> <span class="o">=</span> <span class="s1">&#39;COPERNICUS/S3/OLCI&#39;</span>

    <span class="c1"># Query for Sentinel-3 data within the specified date range and area of interest</span>
    <span class="n">S3_collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">S3_product</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">area_of_interest</span><span class="p">)</span>

    <span class="c1"># Convert S3_collection to a list of image IDs</span>
    <span class="n">S3_image_ids</span> <span class="o">=</span> <span class="n">S3_collection</span><span class="o">.</span><span class="n">aggregate_array</span><span class="p">(</span><span class="s1">&#39;system:index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
    <span class="n">S3_images_info</span> <span class="o">=</span> <span class="n">S3_collection</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
    
    <span class="c1"># Initialize an empty list to store details</span>
    <span class="n">S3_image_details</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Iterate through each image in the collection</span>
    <span class="k">for</span> <span class="n">img_info</span> <span class="ow">in</span> <span class="n">S3_images_info</span><span class="p">:</span>
        <span class="c1"># Fetch image ID</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="n">img_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
        <span class="c1"># Fetch image date and other properties as needed</span>
        <span class="n">image_date</span> <span class="o">=</span> <span class="n">img_info</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;system:time_start&#39;</span><span class="p">]</span>  <span class="c1"># Example property</span>
        
        <span class="c1"># Append the details to the list</span>
        <span class="n">S3_image_details</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">image_date</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">S3_image_details</span>

<span class="k">def</span> <span class="nf">get_s2_images_in_arctic</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">max_cloud_percentage</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves Sentinel-2 images within the Arctic region for a specified date range and cloud coverage limit.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    start_date (str): The starting date for the image collection in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    end_date (str): The ending date for the image collection in &#39;YYYY-MM-DD&#39; format.</span>
<span class="sd">    area (ee.Geometry): The geographical area within which to filter the Sentinel-2 images.</span>
<span class="sd">    max_cloud_percentage (float, optional): The maximum cloud coverage percentage for filtering images. </span>
<span class="sd">                                            Defaults to 10 percent.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ee.ImageCollection: A collection of Sentinel-2 images that fall within the specified date range,</span>
<span class="sd">                        cloud coverage limit, and geographical area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the Arctic region bounding box</span>
    <span class="n">arctic_region</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Geometry</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>

    <span class="c1"># Filter the Sentinel-2 collection</span>
    <span class="n">s2_collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s1">&#39;COPERNICUS/S2&#39;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">arctic_region</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Filter</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="s1">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="p">,</span> <span class="n">max_cloud_percentage</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">s2_collection</span>


<span class="k">def</span> <span class="nf">find_colocated_s3_for_s2</span><span class="p">(</span><span class="n">s2_image</span><span class="p">,</span> <span class="n">buffer_distance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">time_window_hours</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds Sentinel-3 images that are temporally and spatially colocated with a given Sentinel-2 image.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    s2_image (ee.Image): The Sentinel-2 image to use as a reference for finding colocated Sentinel-3 images.</span>
<span class="sd">    buffer_distance (int, optional): The buffer distance in meters to apply to the footprint of the Sentinel-2 image.</span>
<span class="sd">                                     Defaults to 10,000 meters.</span>
<span class="sd">    time_window_hours (int, optional): The time window in hours to search for Sentinel-3 images before and after</span>
<span class="sd">                                       the Sentinel-2 image&#39;s acquisition time. Defaults to 2 hours.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ee.List: A list of Sentinel-3 images that are within the specified time window and overlapping</span>
<span class="sd">             the buffered footprint of the provided Sentinel-2 image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Buffer the S2 footprint and define time window</span>
    <span class="n">s2_geometry</span> <span class="o">=</span> <span class="n">s2_image</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer_distance</span><span class="p">)</span>
    <span class="n">s2_time</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">s2_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system:time_start&#39;</span><span class="p">))</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">s2_time</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="o">-</span><span class="n">time_window_hours</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">s2_time</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">time_window_hours</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>

    <span class="c1"># Query for S3 images</span>
    <span class="n">s3_collection</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s1">&#39;COPERNICUS/S3/OLCI&#39;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">s2_geometry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s3_collection</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="n">s3_collection</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-get-the-pairs-of-colocated-s2-s3">
<h2>Step 1: Get the Pairs of Colocated S2/S3<a class="headerlink" href="#step-1-get-the-pairs-of-colocated-s2-s3" title="Permalink to this heading">#</a></h2>
<p>Once you have set up your environment and are authenticated with Google Earth Engine, the next step is to extract the matched filenames that meet your specific criteria. This involves querying the Google Earth Engine datasets based on your area of interest, time frame, and any other relevant parameters. We will get a list of matched filenames but we only select one of them to downlaod. The code snippet below demonstrates how to perform this task effectively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2019-03-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2019-03-02&#39;</span>
<span class="n">s2_collection</span> <span class="o">=</span> <span class="n">get_s2_images_in_arctic</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

<span class="c1"># Iterate over S2 images and find colocated S3 images</span>
<span class="n">matched_pairs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">s2_list</span> <span class="o">=</span> <span class="n">s2_collection</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="n">s2_collection</span><span class="o">.</span><span class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s2_info</span> <span class="ow">in</span> <span class="n">s2_list</span><span class="p">:</span>
    <span class="n">s2_image</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">s2_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="n">colocated_s3</span> <span class="o">=</span> <span class="n">find_colocated_s3_for_s2</span><span class="p">(</span><span class="n">s2_image</span><span class="p">)</span>
    <span class="n">s3_info_list</span> <span class="o">=</span> <span class="n">colocated_s3</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s3_info</span> <span class="ow">in</span> <span class="n">s3_info_list</span><span class="p">:</span>
        <span class="n">matched_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s2_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">s3_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

<span class="c1"># Print or process the matched pairs</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;S2 Image:&quot;</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;has colocated S3 Image:&quot;</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCM has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCM has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCS has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCS has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190302T000449_20190302T000749
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCS has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCT has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCT has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190302T000449_20190302T000749
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCT has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCU has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCU has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190302T000449_20190302T000749
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCU has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCV has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T01WCV has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T60WWD has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190301T222350_20190301T222650
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T60WWD has colocated S3 Image: COPERNICUS/S3/OLCI/S3A_20190302T000449_20190302T000749
S2 Image: COPERNICUS/S2/20190301T235611_20190301T235610_T60WWD has colocated S3 Image: COPERNICUS/S3/OLCI/S3B_20190301T232521_20190301T232821
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">access_token</span> <span class="o">=</span> <span class="n">token</span> 
<span class="n">download_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">gee_filename</span> <span class="o">=</span> <span class="s1">&#39;20190301T235611_20190301T235610_T01WCU&#39;</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">file_name</span><span class="p">,</span> <span class="n">product_id</span> <span class="o">=</span> <span class="n">process_image_pair</span><span class="p">(</span><span class="n">gee_filename</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="n">download_single_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>S2A_MSIL1C_20190301T235611_N0207_R116_T01WCU_20190302T014622.SAFE
</pre></div>
</div>
</div>
</div>
<section id="proceeding-with-sentinel-3-olci-download">
<h3>Proceeding with Sentinel-3 OLCI Download<a class="headerlink" href="#proceeding-with-sentinel-3-olci-download" title="Permalink to this heading">#</a></h3>
<p>Moving forward, we turn our attention to downloading the Sentinel-3 OLCI data. The process mirrors the approach we took with Sentinel-2, maintaining consistency in our methodology. We’ll apply the same logic of filename conversion and follow the structured steps to retrieve the data from the Copernicus dataspace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example GEE image ID</span>
<span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">gee_image_id</span> <span class="o">=</span> <span class="s1">&#39;S3B_20190301T232521_20190301T232821&#39;</span>
<span class="c1"># Parse the GEE filename to get the date and time</span>
<span class="n">satellite</span><span class="p">,</span> <span class="n">sensing_date</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">parse_gee_filename_s3</span><span class="p">(</span><span class="n">gee_image_id</span><span class="p">)</span>

<span class="c1"># Query the Copernicus Data Space for the corresponding Sentinel-3 OLCI data</span>
<span class="n">s3_olci_data</span> <span class="o">=</span> <span class="n">query_sentinel3_olci_data</span><span class="p">(</span><span class="n">satellite</span><span class="p">,</span> <span class="n">sensing_date</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="n">download_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># Replace with your desired download directory</span>
<span class="n">product_id</span> <span class="o">=</span> <span class="n">s3_olci_data</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="n">s3_olci_data</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
<span class="c1"># Download the single product</span>
<span class="n">download_single_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://catalogue.dataspace.copernicus.eu/odata/v1/Products?$filter=contains(Name,&#39;S3B_OL_1_EFR&#39;) and ContentDate/Start ge 2019-03-01T23:25:20.000Z and ContentDate/Start le 2019-03-02T23:25:20.000Z&amp;$orderby=ContentDate/Start&amp;$top=1000
S3B_OL_1_EFR____20190301T232521_20190301T232821_20190303T043409_0179_022_301_1800_LN1_O_NT_002.SEN3
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-colocated-altimetry-data-of-sentinel-3-olci">
<h3>Downloading Colocated Altimetry Data of Sentinel-3 OLCI<a class="headerlink" href="#downloading-colocated-altimetry-data-of-sentinel-3-olci" title="Permalink to this heading">#</a></h3>
<p>The Sentinel-3 satellite offers an exceptional capability in Earth observation: the simultaneous acquisition of optical data from its OLCI instrument and altimetry measurements.  In this section, we will guide you through the process of downloading this colocated altimetry data alongside the Sentinel-3 OLCI optical data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain an access token to the Copernicus Data Space Ecosystem.</span>
<span class="sd">    Necessary for the download of hosted products.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;curl --location --request POST &#39;https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token&#39; </span><span class="se">\</span>
<span class="s2">            --header &#39;Content-Type: application/x-www-form-urlencoded&#39; </span><span class="se">\</span>
<span class="s2">            --data-urlencode &#39;grant_type=password&#39; </span><span class="se">\</span>
<span class="s2">            --data-urlencode &#39;username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\</span>
<span class="s2">            --data-urlencode &#39;password=</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\</span>
<span class="s2">            --data-urlencode &#39;client_id=cdse-public&#39;&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">access_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">access_dict</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span> <span class="n">access_dict</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">]</span>

<span class="c1">#=============================================================================================================================================================#</span>

<span class="k">def</span> <span class="nf">get_new_access_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a new access token to the Copernicus Data Space Ecosystem using a previously provided refesh token.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span>  <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;curl --location --request POST &#39;https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token&#39; </span><span class="se">\</span>
<span class="s2">    --header &#39;Content-Type: application/x-www-form-urlencoded&#39; </span><span class="se">\</span>
<span class="s2">    --data-urlencode &#39;grant_type=refresh_token&#39; </span><span class="se">\</span>
<span class="s2">    --data-urlencode &#39;refresh_token=</span><span class="si">{</span><span class="n">refresh_token</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\</span>
<span class="s2">    --data-urlencode &#39;client_id=cdse-public&#39;&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">access_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">access_dict</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span> <span class="n">access_dict</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">]</span>

<span class="c1">#=============================================================================================================================================================#</span>

<span class="k">def</span> <span class="nf">get_S3_SI_search_results_df</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a pandas dataframe of Sentinel-3 sea ice thematic products for a given date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">json</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://catalogue.dataspace.copernicus.eu/odata/v1/Products?$filter=Collection/Name eq &#39;SENTINEL-3&#39; and Attributes/OData.CSC.StringAttribute/any(att:att/Name eq &#39;productType&#39; and att/OData.CSC.StringAttribute/Value eq &#39;SR_2_LAN_SI&#39;) and Attributes/OData.CSC.StringAttribute/any(att:att/Name eq &#39;timeliness&#39; and att/OData.CSC.StringAttribute/Value eq &#39;NT&#39;) and ContentDate/Start gt </span><span class="si">{</span><span class="p">(</span><span class="n">date</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> and ContentDate/End lt </span><span class="si">{</span><span class="p">(</span><span class="n">date</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&amp;$top=1000&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span> 
    <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ContentDate&#39;</span><span class="p">][</span><span class="s1">&#39;Start&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span> 
    <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;SensingEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ContentDate&#39;</span><span class="p">][</span><span class="s1">&#39;End&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span> 
    <span class="n">results_df</span> <span class="o">=</span>  <span class="n">results_df</span><span class="p">[(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;SensingEnd&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results_df</span> 


<span class="c1">#=============================================================================================================================================================#</span>

<span class="k">def</span> <span class="nf">filter_duplicate_products_versions</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">keep_latest</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter Sentinel-3 product dataframe to remove duplicate verions of files.</span>
<span class="sd">    By default, we keep the latest version of the file. E.g., where an operation version</span>
<span class="sd">    and a reprocessed version exists, we keep the reprocessed version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;name_snippet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][:</span><span class="mi">47</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">results_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span> 
    <span class="k">if</span>  <span class="n">keep_latest</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">keep</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span>
    
    <span class="n">results_df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">results_df</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;ModificationDate&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name_snippet&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="n">keep</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name_snippet&#39;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;SensingStart&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">results_df</span>

<span class="k">def</span> <span class="nf">find_overlapping_sar</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">,</span> <span class="n">search_results_df</span><span class="p">):</span>
    <span class="c1"># Extract date and time from OLCI filename</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">olci_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">olci_date_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">)</span>

    <span class="c1"># Filter SAR filenames based on overlapping criteria</span>
    <span class="c1"># This is a placeholder logic, adjust according to your specific criteria</span>
    <span class="n">overlapping_sar</span> <span class="o">=</span> <span class="n">search_results_df</span><span class="p">[</span><span class="n">search_results_df</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;S3&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s1">&#39;SR_2_LAN_SI&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">overlapping_sar</span>


<span class="k">def</span> <span class="nf">get_date_from_olci_filename</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the date from an OLCI filename.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    olci_filename (str): The OLCI filename.</span>

<span class="sd">    Returns:</span>
<span class="sd">    datetime.date: The date extracted from the filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">olci_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">date_str</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># Extract date part and truncate to YYYYMMDD format</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_overlapping_sar_file</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">,</span> <span class="n">get_S3_SI_search_results_df</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">olci_date</span> <span class="o">=</span> <span class="n">get_date_from_olci_filename</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">olci_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">olci_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="n">all_overlapping_sar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  <span class="c1"># Collect all overlapping SAR files</span>

    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>
        <span class="n">search_results_df</span> <span class="o">=</span> <span class="n">get_S3_SI_search_results_df</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">search_results_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No SAR data found for date: </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filter_duplicate_products_versions</span><span class="p">(</span><span class="n">search_results_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No SAR data after filtering for date: </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">overlapping_sar</span> <span class="o">=</span> <span class="n">find_overlapping_sar</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">,</span> <span class="n">filtered_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overlapping_sar</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">all_overlapping_sar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_overlapping_sar</span><span class="p">,</span> <span class="n">overlapping_sar</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_overlapping_sar</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">check_overlap</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">olci_filename</span><span class="p">,</span> <span class="n">olci_start</span><span class="p">,</span> <span class="n">olci_end</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the SAR file&#39;s sensing period overlaps with the OLCI file&#39;s sensing period and if it&#39;s from the same satellite.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    row (Series): A row from the SAR search results DataFrame.</span>
<span class="sd">    olci_filename (str): The OLCI filename.</span>
<span class="sd">    olci_start (datetime): Start time of OLCI sensing period.</span>
<span class="sd">    olci_end (datetime): End time of OLCI sensing period.</span>

<span class="sd">    Returns:</span>
<span class="sd">    bool: True if there&#39;s an overlap and the satellite is consistent, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract satellite identifier from the OLCI filename</span>
    <span class="n">satellite</span> <span class="o">=</span> <span class="n">olci_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># e.g., S3A or S3B</span>

    <span class="c1"># Parse SAR start and end times</span>
    <span class="n">sar_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ContentDate&#39;</span><span class="p">][</span><span class="s1">&#39;Start&#39;</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">)</span>
    <span class="n">sar_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ContentDate&#39;</span><span class="p">][</span><span class="s1">&#39;End&#39;</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">)</span>

    <span class="c1"># Check for temporal overlap and satellite consistency</span>
    <span class="n">is_temporal_overlap</span> <span class="o">=</span> <span class="n">sar_start</span> <span class="o">&lt;=</span> <span class="n">olci_end</span> <span class="ow">and</span> <span class="n">sar_end</span> <span class="o">&gt;=</span> <span class="n">olci_start</span>
    <span class="n">is_same_satellite</span> <span class="o">=</span> <span class="n">satellite</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">is_temporal_overlap</span> <span class="ow">and</span> <span class="n">is_same_satellite</span>

<span class="c1"># Adjust the find_overlapping_sar function to include the OLCI filename in the check_overlap call</span>
<span class="k">def</span> <span class="nf">find_overlapping_sar</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">,</span> <span class="n">search_results_df</span><span class="p">):</span>
    <span class="c1"># Extract date and time from OLCI filename</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">olci_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">olci_sensing_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">olci_sensing_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">T%H%M%S&#39;</span><span class="p">)</span>

    <span class="c1"># Filter for SAR files that overlap with the OLCI sensing period</span>
    <span class="n">overlapping_sar</span> <span class="o">=</span> <span class="n">search_results_df</span><span class="p">[</span><span class="n">search_results_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">check_overlap</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">olci_filename</span><span class="p">,</span> <span class="n">olci_sensing_start</span><span class="p">,</span> <span class="n">olci_sensing_end</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">overlapping_sar</span>


    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example usage</span>

<span class="n">token</span><span class="p">,</span> <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">olci_filename</span> <span class="o">=</span> <span class="n">s3_olci_data</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">## This is an example, which you should replace with the one you are interested in.</span>
<span class="n">overlapped_df</span> <span class="o">=</span> <span class="n">get_overlapping_sar_file</span><span class="p">(</span><span class="n">olci_filename</span><span class="p">,</span> <span class="n">get_S3_SI_search_results_df</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
<span class="n">product_id</span> <span class="o">=</span> <span class="n">overlapped_df</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="n">overlapped_df</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">download_dir</span> <span class="o">=</span> <span class="s1">&#39;/Users/weibinchen/Desktop/UCL/PhD_Year_1/Data/&#39;</span>
<span class="n">download_single_product</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ve now gathered Sentinel-2 optical data, Sentinel-3 OLCI, and altimetry data, enabling us to advance into a comprehensive analysis leveraging their combined strengths.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Chapter%201%3Arollout.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Roll-out on a Full Image</p>
      </div>
    </a>
    <a class="right-next"
       href="Chapter1%3AUnsupervised_Learning_Methods.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Unsupervised Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-0-read-in-functions-needed">Step 0: Read in Functions Needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-get-the-pairs-of-colocated-s2-s3">Step 1: Get the Pairs of Colocated S2/S3</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proceeding-with-sentinel-3-olci-download">Proceeding with Sentinel-3 OLCI Download</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-colocated-altimetry-data-of-sentinel-3-olci">Downloading Colocated Altimetry Data of Sentinel-3 OLCI</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michel Tsamados/Weibin Chen
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>